version: "3.8"

# ============================================
# MBUY Local AI Stack
# ============================================
# الخدمات:
# - AnythingLLM: واجهة ذكية لتحليل بيانات التجار
# - n8n: أتمتة العمليات
# - FFmpeg: معالجة الوسائط
# ============================================

services:
  # ============================================
  # AnythingLLM - تحليل بيانات التجار
  # الوصول: http://localhost:3001
  # ============================================
  anythingllm:
    image: mintplexlabs/anythingllm:latest
    container_name: anythingllm
    ports:
      - "3001:3001"
    environment:
      - STORAGE_DIR=/app/server/storage
    volumes:
      - ./anythingllm-docker/storage:/app/server/storage
      - ./anythingllm-docker/collector:/app/collector/hotdir
    extra_hosts:
      # هذا يسمح للحاوية بالاتصال بـ Ollama على Windows
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    networks:
      - mbuy-ai

  # ============================================
  # n8n - الأتمتة
  # الوصول: http://localhost:5678
  # ============================================
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    ports:
      - "5678:5678"
    environment:
      - N8N_HOST=localhost
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY:-change-this-to-random-string}
      - GENERIC_TIMEZONE=Asia/Riyadh
      - TZ=Asia/Riyadh
    volumes:
      - ./n8n-docker/n8n_data:/home/node/.n8n
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    networks:
      - mbuy-ai

  # ============================================
  # FFmpeg - معالجة الفيديو والصور
  # استخدام: docker exec ffmpeg ffmpeg [options]
  # ============================================
  ffmpeg:
    image: linuxserver/ffmpeg:latest
    container_name: ffmpeg
    volumes:
      - ./media/input:/input
      - ./media/output:/output
    entrypoint: [ "tail", "-f", "/dev/null" ]
    restart: unless-stopped
    networks:
      - mbuy-ai

networks:
  mbuy-ai:
    driver: bridge
    name: mbuy-ai-network

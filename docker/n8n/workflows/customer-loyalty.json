{
  "name": "mBuy - Customer Welcome & Loyalty",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "mbuy-customer-webhook",
        "options": {}
      },
      "id": "customer-webhook",
      "name": "Customer Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.event }}",
              "operation": "equals",
              "value2": "customer.created"
            }
          ]
        }
      },
      "id": "check-new-customer",
      "name": "Is New Customer?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [450, 200]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.event }}",
              "operation": "equals",
              "value2": "loyalty.tier_upgraded"
            }
          ]
        }
      },
      "id": "check-tier-upgrade",
      "name": "Is Tier Upgrade?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [450, 400]
    },
    {
      "parameters": {
        "fromEmail": "welcome@mbuy.sa",
        "toEmail": "={{ $json.data.email }}",
        "subject": "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ mBuy! ğŸ‰",
        "html": "<div dir='rtl' style='font-family: Arial, sans-serif;'><h1>Ù…Ø±Ø­Ø¨Ø§Ù‹ {{ $json.data.full_name }}!</h1><p>Ù†Ø±Ø­Ø¨ Ø¨Ùƒ ÙÙŠ Ø¹Ø§Ø¦Ù„Ø© mBuy.</p><p>Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒÙˆØ¯ <strong>WELCOME10</strong> Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø®ØµÙ… 10% Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø£ÙˆÙ„!</p><p>Ù…Ø¹ ØªØ­ÙŠØ§Øª ÙØ±ÙŠÙ‚ mBuy</p></div>"
      },
      "id": "send-welcome-email",
      "name": "Send Welcome Email",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 1,
      "position": [700, 100]
    },
    {
      "parameters": {
        "url": "https://api.unifonic.com/rest/Messages/Send",
        "method": "POST",
        "bodyParameters": {
          "parameters": [
            {
              "name": "AppSid",
              "value": "={{ $env.UNIFONIC_APP_SID }}"
            },
            {
              "name": "Recipient",
              "value": "={{ $json.data.phone }}"
            },
            {
              "name": "Body",
              "value": "Ù…Ø±Ø­Ø¨Ø§Ù‹ {{ $json.data.full_name }}! ğŸ‰ Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ³Ø¬ÙŠÙ„Ùƒ ÙÙŠ mBuy. Ø§Ø³ØªØ®Ø¯Ù… ÙƒÙˆØ¯ WELCOME10 Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø®ØµÙ… 10% Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø£ÙˆÙ„!"
            },
            {
              "name": "SenderID",
              "value": "mBuy"
            }
          ]
        }
      },
      "id": "send-welcome-sms",
      "name": "Send Welcome SMS",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [700, 250]
    },
    {
      "parameters": {
        "fromEmail": "loyalty@mbuy.sa",
        "toEmail": "={{ $json.data.email }}",
        "subject": "ğŸŠ ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ù„Ù‚Ø¯ ØªØ±Ù‚ÙŠØª Ø¥Ù„Ù‰ {{ $json.data.new_tier }}",
        "html": "<div dir='rtl' style='font-family: Arial, sans-serif;'><h1>ØªÙ‡Ø§Ù†ÙŠÙ†Ø§ {{ $json.data.customer_name }}! ğŸŠ</h1><p>Ù„Ù‚Ø¯ ØªØ±Ù‚ÙŠØª Ø¥Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ <strong>{{ $json.data.new_tier }}</strong> ÙÙŠ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ÙˆÙ„Ø§Ø¡!</p><p>Ø§Ø³ØªÙ…ØªØ¹ Ø¨Ù…Ø²Ø§ÙŠØ§ Ø­ØµØ±ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©.</p></div>"
      },
      "id": "send-tier-upgrade-email",
      "name": "Send Tier Upgrade Email",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 1,
      "position": [700, 400]
    },
    {
      "parameters": {
        "url": "={{ $env.MBUY_API_URL }}/webhooks/send-notification",
        "method": "POST",
        "bodyParameters": {
          "parameters": [
            {
              "name": "customerId",
              "value": "={{ $json.data.customer_id }}"
            },
            {
              "name": "type",
              "value": "tier_upgrade"
            },
            {
              "name": "title",
              "value": "ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! ğŸŠ"
            },
            {
              "name": "message",
              "value": "Ù„Ù‚Ø¯ ØªØ±Ù‚ÙŠØª Ø¥Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ {{ $json.data.new_tier }}!"
            }
          ]
        }
      },
      "id": "send-push-notification",
      "name": "Send Push Notification",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [700, 550]
    }
  ],
  "connections": {
    "Customer Webhook": {
      "main": [
        [
          {
            "node": "Is New Customer?",
            "type": "main",
            "index": 0
          },
          {
            "node": "Is Tier Upgrade?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is New Customer?": {
      "main": [
        [
          {
            "node": "Send Welcome Email",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send Welcome SMS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Tier Upgrade?": {
      "main": [
        [
          {
            "node": "Send Tier Upgrade Email",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send Push Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": ["mBuy", "customers", "loyalty"]
}

# โ ุงูุชูููู ุงูููุงุฆู ูุญู ูุดููุฉ FORBIDDEN

## ๐ ุชูููู ุงูุญู ุงููุทุจู

### โ ุงููุชูุฌุฉ: **ููุชุงุฒ** (9.5/10)

---

## โ ููุงุท ุงูููุฉ

### 1. ุญู ุงููุดููุฉ ุงูุฃุณุงุณูุฉ โ
- โ ูุถูู `user_id` ุงูุฐู ูุชุทุงุจู ูุน `auth.uid()`
- โ RLS Policies ุชุนูู ุจุดูู ุตุญูุญ
- โ ูุญู ูุดููุฉ FORBIDDEN ุจุดูู ูุงูู

### 2. ุงูุฃูุงู โ
- โ RLS Policies ูุญููุฉ ูุขููุฉ
- โ ุชุชุญูู ูู `role = 'merchant'`
- โ ุชุชุญูู ูู ููููุฉ ุงููุชุฌุฑ ุนุจุฑ JOIN
- โ CHECK constraint ูุถูู `user_id = id`

### 3. ุงูุฃุฏุงุก โ
- โ ููุงุฑุณ ุนูู `user_id` ู `full_name`
- โ JOINs ูุนุงูุฉ ูู RLS Policies
- โ Trigger ููุชุฒุงูู ุงูุชููุงุฆู

### 4. ุงููุถูุญ โ
- โ `user_id` ูุงุถุญ ูู ุงููุซุงุฆู
- โ RLS Policies ูุงุถุญุฉ ููุจุงุดุฑุฉ
- โ ุชุนูููุงุช ุชูุถูุญูุฉ ุดุงููุฉ

### 5. ุงููุฑููุฉ โ
- โ `full_name` ูุชุงุญ ููุงุณุชุฎุฏุงู
- โ `user_id` ูููู ุฃู ูููู ูุฑูุงู ูุณุชูุจูุงู
- โ ูุง ูููุน ุงูุชุทููุฑ ุงููุณุชูุจูู

---

## ๐ ุงูุชุญุณููุงุช ุงููุถุงูุฉ

### 1. CHECK Constraint โ
```sql
ALTER TABLE user_profiles
  ADD CONSTRAINT user_profiles_user_id_equals_id 
  CHECK (user_id = id);
```

**ุงููุงุฆุฏุฉ:**
- โ ูุถูู `user_id = id` ุฏุงุฆูุงู ุนูู ูุณุชูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ูููุน ุงูุฃุฎุทุงุก ูู ุงูุจูุงูุงุช

### 2. Trigger ููุชุฒุงูู ุงูุชููุงุฆู โ
```sql
CREATE TRIGGER sync_user_profiles_user_id_trigger
BEFORE INSERT OR UPDATE ON user_profiles
FOR EACH ROW
EXECUTE FUNCTION sync_user_profiles_user_id();
```

**ุงููุงุฆุฏุฉ:**
- โ ูุถูู `user_id = id` ุชููุงุฆูุงู ุนูุฏ INSERT/UPDATE
- โ ูุง ูุญุชุงุฌ ุชุญุฏูุซ ูุฏูู

---

## ๐ ููุงุฑูุฉ ูุน ุงูุจุฏุงุฆู

### ุงูุจุฏูู 1: ุงุณุชุฎุฏุงู `id` ูุจุงุดุฑุฉ
```sql
USING (id = auth.uid())  -- ุจุฏูุงู ูู user_id = auth.uid()
```

**ุงูุนููุจ:**
- โ ุฃูู ูุถูุญุงู
- โ ุฅุฐุง ุชุบูุฑุช ุงูุนูุงูุฉุ ูุญุชุงุฌ ุชุนุฏูู

**ุงูุญูู:** ุงูุญู ุงูุญุงูู ุฃูุถู โ

---

### ุงูุจุฏูู 2: Generated Column
```sql
ALTER TABLE user_profiles 
  ADD COLUMN user_id UUID GENERATED ALWAYS AS (id) STORED;
```

**ุงููุฒุงูุง:**
- โ ูุง ูููู ุชุบููุฑู
- โ ุฏุงุฆูุงู ูุชุฒุงูู

**ุงูุนููุจ:**
- โ๏ธ ุฃูู ูุฑููุฉ
- โ๏ธ ูุฏ ูุง ุชุฏุนููุง ุฌููุน ุงูุฅุตุฏุงุฑุงุช

**ุงูุญูู:** ุงูุนููุฏ ุงูุนุงุฏู + Trigger + Constraint ุฃูุถู โ

---

### ุงูุจุฏูู 3: ุจุฏูู `user_id` (ุงุณุชุฎุฏุงู `id` ููุท)
```sql
-- RLS Policy
USING (id = auth.uid())
```

**ุงูุนููุจ:**
- โ ุฃูู ูุถูุญุงู ูู ุงููุซุงุฆู
- โ ูุง ูุฏุนู ุงูุงุณุชุฎุฏุงู ุงููุณุชูุจูู

**ุงูุญูู:** ุงูุญู ุงูุญุงูู ุฃูุถู โ

---

## ๐ฏ ุงูุฎูุงุตุฉ

### ุงูุญู ุงููุทุจู: **ููุชุงุฒ ููุญุณูู** โ

**ุงูุฃุณุจุงุจ:**
1. โ ูุญู ุงููุดููุฉ ุจุดูู ูุงูู
2. โ ุขูู ููุญูู (RLS + Constraint + Trigger)
3. โ ูุนุงู (ูููุฑุณ ููุญุณูู)
4. โ ูุงุถุญ (ุณูู ุงูููู ูุงููุซุงุฆู)
5. โ ูุฑู (ูุงุจู ููุชูุณุน)
6. โ ููุซูู (CHECK constraint + Trigger)

---

## โ ุงูุชูุตูุฉ ุงูููุงุฆูุฉ

### ุงูุญู ุงููุทุจู ุตุญูุญ ูููุชุงุฒ โ

**ูุง ุญุงุฌุฉ ูุชุบููุฑุงุช ุฃุณุงุณูุฉ** - ุงูุญู:
- โ ูุญู ุงููุดููุฉ
- โ ุขูู
- โ ูุญุณูู
- โ ุดุงูู

**ุงูุชุญุณููุงุช ุงููุถุงูุฉ:**
- โ CHECK constraint
- โ Trigger ููุชุฒุงูู

---

## ๐ ุงูุฎุทูุฉ ุงูุชุงููุฉ

1. โ ุชุดุบูู Migration ูู Supabase
2. โ ุงุฎุชุจุงุฑ ุฅุถุงูุฉ ููุชุฌ
3. โ ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ FORBIDDEN

**ุงูุญู ุฌุงูุฒ ูุฌูุฏ ุฌุฏุงู!** ๐


# ๐ ูุฑุงุฌุนุฉ ุฅุตูุงุญ RLS - ุงูุชูููู ูุงูุชูุตูุงุช

## ๐ ูุง ุชู ุชุทุจููู

### 1. ุฅุถุงูุฉ ุงูุฃุนูุฏุฉ:
- โ `user_id UUID` โ `auth.users(id)` (FK)
- โ `full_name TEXT`

### 2. ุชุญุฏูุซ ุงูุจูุงูุงุช:
- โ `user_id = id` ูุฌููุน ุงูุตููู
- โ `full_name = display_name`

### 3. RLS Policies:
- โ `user_profiles`: ุชุณุชุฎุฏู `user_id = auth.uid()`
- โ `products`: ุชุณุชุฎุฏู JOIN ูุน `user_profiles.user_id = auth.uid()`
- โ `stores`: ุชุณุชุฎุฏู JOIN ูุน `user_profiles.user_id = auth.uid()`

---

## โ ููุงุท ุงูููุฉ ูู ุงูุญู ุงูุญุงูู

1. **ูุถูุญ ุงูุนูุงูุฉ:**
   - `user_id` ููุถุญ ุจุดูู ุตุฑูุญ ุฃูู FK ุฅูู `auth.users.id`
   - RLS Policies ูุงุถุญุฉ: `user_id = auth.uid()`

2. **ุงููุฑููุฉ:**
   - ูููู ุงุณุชุฎุฏุงู `user_id` ูู ุงุณุชุนูุงูุงุช ูุณุชูุจููุฉ
   - `full_name` ูุชุงุญ ููุงุณุชุฎุฏุงู ูู ุงููุงุฌูุงุช

3. **ุงูุฃูุงู:**
   - RLS Policies ูุญููุฉ
   - ุงูุชุญูู ูู `role = 'merchant'` ูู ุณูุงุณุงุช products

---

## โ๏ธ ููุงุญุธุงุช ูุชุญุณููุงุช ูุญุชููุฉ

### 1. ุงูุชูุฑุงุฑ ุจูู `id` ู `user_id`:

**ุงูุญุงูุฉ ุงูุญุงููุฉ:**
- `user_profiles.id` = `auth.users.id` (FK ูุจุงุดุฑ)
- `user_profiles.user_id` = `auth.users.id` (FK ุฌุฏูุฏ)
- ุงููุชูุฌุฉ: `id = user_id` ุฏุงุฆูุงู

**ุงูุจุฏูู ุงููุญุชูู:**
ูููู ุงุณุชุฎุฏุงู `id` ูุจุงุดุฑุฉ ูู RLS Policies:
```sql
USING (id = auth.uid())  -- ุจุฏูุงู ูู user_id = auth.uid()
```

**ููู ุงูุญู ุงูุญุงูู ุฃูุถู ูุฃู:**
- โ ุฃูุถุญ ูู ุงูุชุนูููุงุช ูุงููุซุงุฆู
- โ ุฅุฐุง ุชุบูุฑุช ุงูุนูุงูุฉ ูุณุชูุจูุงูุ `user_id` ูููู ุฃู ูููู ูุฑูุงู
- โ ูุง ููุฌุฏ ุถุฑุฑ ูู ูุฌูุฏ ุงูุนููุฏูู

---

### 2. ุงุณุชุฎุฏุงู Generated Column (ุจุฏูุงู ูู ุนููุฏ ุนุงุฏู):

**ุงูุจุฏูู:**
```sql
ALTER TABLE user_profiles 
  ADD COLUMN user_id UUID GENERATED ALWAYS AS (id) STORED;
```

**ุงููุฒุงูุง:**
- โ ูุง ูููู ุชุบููุฑ `user_id` ูุฏููุงู
- โ ุฏุงุฆูุงู ูุชุฒุงูู ูุน `id`
- โ ุฃูู ุงุญุชูุงูุงู ููุฃุฎุทุงุก

**ุงูุนููุจ:**
- โ๏ธ ุจุนุถ ููุงุนุฏ ุงูุจูุงูุงุช ูุฏ ูุง ุชุฏุนููุง ุจุดูู ูุงูู
- โ๏ธ ูุฏ ุชููู ูุนูุฏุฉ ูู ุจุนุถ ุงูุณููุงุฑูููุงุช

**ุงูุชูุตูุฉ:** ุงูุญู ุงูุญุงูู (ุนููุฏ ุนุงุฏู ูุน UPDATE) ุฌูุฏ ูุขูู โ

---

### 3. RLS Policies - ุงูุชุญูู ูู `role`:

**ูู ุณูุงุณุฉ INSERT ูู products:**
```sql
AND user_profiles.role = 'merchant'
```

**ูุฐุง ุตุญูุญ โ** ูุฃูู ูุถูู ุฃู ููุท ุงูุชุฌุงุฑ ูููููู ุฅุถุงูุฉ ููุชุฌุงุช.

---

### 4. ุงุณุชุฎุฏุงู INDEX ุนูู `user_id`:

**ุชู ุฅุถุงูุชู โ:**
```sql
CREATE INDEX IF NOT EXISTS idx_user_profiles_user_id 
  ON public.user_profiles(user_id);
```

**ููุชุงุฒ โ** - ูุญุณูู ุฃุฏุงุก ุงุณุชุนูุงูุงุช RLS.

---

## ๐ฏ ุงูุชูุตูุงุช ุงูููุงุฆูุฉ

### โ ูุง ุชู ุชุทุจููู ุตุญูุญ ูุฌูุฏ:

1. **ุฅุถุงูุฉ `user_id`:**
   - โ ููุถุญ ุงูุนูุงูุฉ ุจุดูู ุตุฑูุญ
   - โ RLS Policies ูุงุถุญุฉ
   - โ ูููุฑุณ ููุฃุฏุงุก

2. **ุฅุถุงูุฉ `full_name`:**
   - โ ูุชุงุญ ููุงุณุชุฎุฏุงู ูู ุงููุงุฌูุงุช
   - โ ูููู ุฃู ูููู ูุฎุชููุงู ุนู `display_name` ูุณุชูุจูุงู

3. **RLS Policies:**
   - โ ูุญููุฉ ูุขููุฉ
   - โ ุชุชุญูู ูู `role = 'merchant'`
   - โ ุชุณุชุฎุฏู JOIN ุตุญูุญ

---

### ๐ ุฎูุงุฑุงุช ุจุฏููุฉ (ุงุฎุชูุงุฑูุฉ):

#### ุงูุฎูุงุฑ 1: ุงุณุชุฎุฏุงู `id` ูุจุงุดุฑุฉ (ุจุฏูู `user_id`)
```sql
-- RLS Policy
USING (id = auth.uid())  -- ุฃุจุณุทุ ููู ุฃูู ูุถูุญุงู
```

**ุงูุนููุจ:**
- โ ุฃูู ูุถูุญุงู ูู ุงููุซุงุฆู
- โ ุฅุฐุง ุชุบูุฑุช ุงูุนูุงูุฉุ ูุญุชุงุฌ ุชุนุฏูู

#### ุงูุฎูุงุฑ 2: Trigger ูุชุญุฏูุซ `user_id` ุชููุงุฆูุงู
```sql
CREATE TRIGGER sync_user_id
BEFORE INSERT OR UPDATE ON user_profiles
FOR EACH ROW
EXECUTE FUNCTION set_user_id_from_id();
```

**ุงููุฒุงูุง:**
- โ ูุถูู ุงูุชุฒุงูู ุฏุงุฆูุงู

**ุงูุนููุจ:**
- โ๏ธ ุชุนููุฏ ุฅุถุงูู
- โ๏ธ ุงูุญู ุงูุญุงูู (UPDATE) ูุงูู

---

## โ ุงูุฎูุงุตุฉ

### ุงูุญู ุงููุทุจู ุฌูุฏ ูุตุญูุญ โ

**ุงูุฃุณุจุงุจ:**
1. โ ูุญู ุงููุดููุฉ (FORBIDDEN)
2. โ ุขูู ููุญูู
3. โ ูุงุถุญ ูู ุงููุซุงุฆู
4. โ ูููุฑุณ ููุฃุฏุงุก
5. โ ูุฑู ูููุณุชูุจู

**ูุง ุญุงุฌุฉ ูุชุบููุฑุงุช ุฅุถุงููุฉ** - ุงูุญู ุงูุญุงูู ููุงุณุจ ููุนูุงู.

---

## ๐ ุงูุฎุทูุฉ ุงูุชุงููุฉ

1. โ ุชุดุบูู Migration ูู Supabase
2. โ ุงุฎุชุจุงุฑ ุฅุถุงูุฉ ููุชุฌ
3. โ ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุฃุฎุทุงุก FORBIDDEN

**ุงูุญู ุฌุงูุฒ ููุงุณุชุฎุฏุงู!** ๐

